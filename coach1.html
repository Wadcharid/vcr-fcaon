<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Running Coach (Advanced with Pace)</title>
  <style>
    /* รีเซ็ตเบื้องต้น */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: sans-serif;
      background: #f6f8fa;
      color: #333;
      line-height: 1.5;
      padding: 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    header p {
      color: #666;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 2rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    h2 {
      margin-bottom: 1rem;
      text-align: center;
      color: #007BFF;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .form-group select,
    .form-group input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      margin-top: 1.5rem;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #0056b3;
    }

    .result {
      margin-top: 2rem;
    }

    .plan-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .plan-table thead {
      background: #f0f0f0;
    }

    .plan-table th,
    .plan-table td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: center;
    }

    .plan-table th {
      font-weight: 700;
    }

    .no-plan {
      text-align: center;
      color: #999;
      margin-top: 1rem;
    }

    .workout-type {
      font-size: 0.85rem;
      color: #555;
      display: block;
      margin-top: 0.25rem; /* เว้นบรรทัดเล็กน้อย */
    }

    .pace-text {
      font-size: 0.85rem;
      color: #007BFF;
      display: block;
      margin-top: 0.25rem;
    }

    @media (max-width: 600px) {
      .form-group label,
      .form-group input,
      .form-group select {
        font-size: 0.85rem;
      }

      h2 {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>My Running Coach (Advanced with Pace)</h1>
    <p>โค้ชวิ่งอัตโนมัติที่ปรับตารางซ้อมตามระยะเป้าหมายและแสดง Pace แนะนำ</p>
  </header>

  <div class="container">
    <h2>กรอกข้อมูลเพื่อสร้างตารางซ้อม</h2>
    <!-- ฟอร์มกรอกข้อมูลต่าง ๆ -->
    <div class="form-group">
      <label for="distanceGoal">ระยะทางเป้าหมาย (Event ที่ตั้งใจวิ่ง):</label>
      <select id="distanceGoal">
        <option value="5">5K</option>
        <option value="10">10K</option>
        <option value="21">Half Marathon (21K)</option>
        <option value="42">Full Marathon (42K)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="trainingWeeks">จำนวนสัปดาห์ที่ต้องการเตรียมตัว (เช่น 8):</label>
      <input type="number" id="trainingWeeks" placeholder="8" min="1" value="8">
    </div>

    <div class="form-group">
      <label for="runDaysPerWeek">จำนวนวันวิ่งต่อสัปดาห์ (1-7):</label>
      <input type="number" id="runDaysPerWeek" placeholder="3" min="1" max="7" value="3">
    </div>

    <div class="form-group">
      <label for="currentMileage">ไมล์สะสมต่อสัปดาห์ (กม.) ในปัจจุบัน:</label>
      <input type="number" id="currentMileage" placeholder="10" min="0" value="10">
    </div>

    <button class="btn" id="generatePlanBtn">สร้างตารางซ้อม</button>

    <!-- ส่วนแสดงผลตารางซ้อม -->
    <div class="result" id="resultContainer">
      <!-- ตารางหรือข้อความจะแสดงในนี้ด้วย JS -->
    </div>
  </div>

  <!-- JavaScript ส่วนประมวลผล -->
  <script>
    const generatePlanBtn = document.getElementById('generatePlanBtn');
    const resultContainer = document.getElementById('resultContainer');

    // 1) กำหนด "Max (Peak) Mileage" แต่ละระยะ (ตัวอย่างปรับได้)
    const goalMaxMileageMap = {
      5:  30,   // 5K อาจซ้อมถึง ~30 กม./สัปดาห์
      10: 50,   // 10K ~50 กม./สัปดาห์
      21: 70,   // Half Marathon ~70 กม./สัปดาห์
      42: 100   // Full Marathon ~100 กม./สัปดาห์
    };

    // 2) กำหนด "Pace พื้นฐาน" ของแต่ละระยะ (ตัวอย่าง)
    //    เช่น 5K = 6:00, 10K = 6:30, 21K = 7:00, 42K = 7:30 (ปรับได้ตามจริง)
    const baseRacePaceMap = {
      5:  "6:00",
      10: "6:30",
      21: "7:00",
      42: "7:30"
    };

    // 3) Offset Pace สำหรับประเภทการซ้อม (วินาที)
    //    เช่น Easy = +90 วิ, Interval = -30 วิ, Long = +60 วิ ฯลฯ
    const paceOffsetSec = {
      "Easy Run":       90,   // ช้ากว่า race pace 1:30
      "Interval":       -30,  // เร็วกว่าหรือเท่ากับ race pace -30 วินาที
      "Interval/Tempo": -20,  // ตัวอย่าง
      "Tempo":          0,    // เท่ากับ race pace
      "Long Run":       60,   // ช้ากว่า race pace 1:00
      "Recovery Run":   120,  // ช้ากว่า race pace 2:00
      "Rest Day":       null  // วันพัก (ไม่มี pace)
    };

    // ฟังก์ชันแปลง 'm:ss' เป็นวินาที
    function parsePaceToSec(paceStr) {
      // paceStr เช่น "6:00"
      const [m, s] = paceStr.split(":").map(Number);
      return m * 60 + s;
    }

    // ฟังก์ชันแปลงวินาทีเป็น 'm:ss'
    function secToPaceStr(sec) {
      if (sec < 0) sec = 0; // กันไม่ให้เป็นลบ (กรณีคำนวณ offset ติดลบมาก)
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2, "0")}`; // ให้เป็นรูปแบบ mm:ss
    }

    // 4) ฟังก์ชั่นสร้างตารางซ้อม + ใช้ Taper (2 สัปดาห์ท้าย 80%, 60% หาก totalWeeks >= 4)
    function generateTrainingPlan(distanceGoal, totalWeeks, runDays, currentMileage) {
      // อ่านค่าต่าง ๆ จาก map
      const peakMileage = goalMaxMileageMap[distanceGoal] || 30; // fallback
      const baseRacePaceStr = baseRacePaceMap[distanceGoal] || "6:00";

      // เตรียมแปลง pace พื้นฐานเป็นวินาที
      const baseRacePaceSec = parsePaceToSec(baseRacePaceStr);

      // เป้าหมายของเราคือค่อย ๆ ขยับ mileage จาก currentMileage ไปใกล้ peakMileage
      // ในตัวอย่างนี้จะทำแบบง่าย ๆ "Linear Progression" + Taper
      let plan = [];
      let lastWeekMileage = currentMileage;

      for (let w = 1; w <= totalWeeks; w++) {
        let thisWeekMileage;

        if (w === 1) {
          // สัปดาห์แรกใช้ค่าใกล้เคียง currentMileage ไปก่อน
          thisWeekMileage = Math.round(lastWeekMileage);
        } else {
          // ยังไม่เข้า Taper -> ค่อย ๆ ขยับเข้าใกล้ peak
          const notInTaper = (totalWeeks < 4) ? true : (w < totalWeeks - 1); 
          if (notInTaper) {
            // เพิ่มขึ้นทีละนิด ~10% หรือจนเกือบ peak
            let nextMileage = lastWeekMileage * 1.1;
            if (nextMileage > peakMileage) {
              nextMileage = peakMileage;
            }
            thisWeekMileage = Math.round(nextMileage);
          } else {
            // ช่วง Taper (2 สัปดาห์สุดท้าย)
            // สมมติว่า w = totalWeeks-1 => 80% ของสัปดาห์ก่อนหน้า
            // และ w = totalWeeks => 60% ของสัปดาห์ก่อนหน้า
            if (w === totalWeeks - 1) {
              thisWeekMileage = Math.round(lastWeekMileage * 0.8);
            } else {
              // w === totalWeeks
              thisWeekMileage = Math.round(lastWeekMileage * 0.6);
            }
          }
        }

        // สร้างรายการวัน
        const dayData = [];
        const workoutPattern = generateWorkoutPattern(runDays);
        const ratioArr = getDistanceRatio(runDays);

        // กระจายระยะในแต่ละวัน
        let totalRatioSum = ratioArr.reduce((a,b) => a + b, 0);
        for (let d = 0; d < runDays; d++) {
          const dist = Math.round(thisWeekMileage * (ratioArr[d] / totalRatioSum));
          const wType = workoutPattern[d] || "Easy Run";

          // คำนวณ Pace ของวันนั้น
          let paceStr = "N/A";
          if (paceOffsetSec[wType] !== null) {
            const offset = paceOffsetSec[wType] || 0;
            paceStr = secToPaceStr(baseRacePaceSec + offset);
          }

          dayData.push({
            distance: dist,
            workoutType: wType,
            pace: paceStr
          });
        }

        plan.push({
          weekNum: w,
          totalMileage: thisWeekMileage,
          days: dayData
        });

        lastWeekMileage = thisWeekMileage; // เก็บไว้เทียบกับสัปดาห์ถัดไป
      }

      return plan;
    }

    // สร้าง pattern เบื้องต้นของประเภทการซ้อม (Workout Type) ตามจำนวนวัน
    function generateWorkoutPattern(runDays) {
      // ตัวอย่างเพื่อให้เห็นไอเดีย:
      //   3 วัน: [Easy Run, Interval/Tempo, Long Run]
      //   4 วัน: [Easy Run, Interval, Tempo, Long Run]
      //   5 วัน: [Easy Run, Interval, Easy Run, Tempo, Long Run]
      // ฯลฯ
      const pattern3 = ["Easy Run", "Interval/Tempo", "Long Run"];
      const pattern4 = ["Easy Run", "Interval", "Tempo", "Long Run"];
      const pattern5 = ["Easy Run", "Interval", "Easy Run", "Tempo", "Long Run"];
      const pattern6 = ["Easy Run", "Interval", "Tempo", "Easy Run", "Long Run", "Recovery Run"];
      const pattern7 = ["Easy Run", "Interval", "Easy Run", "Tempo", "Long Run", "Recovery Run", "Rest Day"];

      switch (runDays) {
        case 1:
          return ["Long Run"];
        case 2:
          return ["Easy Run", "Long Run"];
        case 3:
          return pattern3;
        case 4:
          return pattern4;
        case 5:
          return pattern5;
        case 6:
          return pattern6;
        case 7:
          return pattern7;
        default:
          return pattern3;
      }
    }

    // สัดส่วนการแบ่งระยะทางต่อวัน (ใน 1 สัปดาห์)
    function getDistanceRatio(runDays) {
      // ตัวอย่างสมมติ สามารถปรับแก้ได้ตามหลักการซ้อมจริง
      switch (runDays) {
        case 1:
          return [1.0];
        case 2:
          return [0.4, 0.6];
        case 3:
          return [0.25, 0.3, 0.45];
        case 4:
          return [0.2, 0.2, 0.25, 0.35];
        case 5:
          return [0.15, 0.2, 0.15, 0.2, 0.3];
        case 6:
          return [0.15, 0.15, 0.15, 0.2, 0.2, 0.15];
        case 7:
          return [0.1, 0.15, 0.15, 0.2, 0.2, 0.15, 0.05];
        default:
          return [0.25, 0.3, 0.45]; // fallback
      }
    }

    // แสดงผลตาราง
    function renderPlan(plan, runDays) {
      if (!plan || plan.length === 0) {
        return '<p class="no-plan">ไม่มีข้อมูลตารางซ้อม</p>';
      }

      let html = `
        <table class="plan-table">
          <thead>
            <tr>
              <th>สัปดาห์</th>
              <th>รวม (กม.)</th>
      `;
      // หัวตารางย่อย
      for (let d = 1; d <= runDays; d++) {
        html += `<th>Day ${d}</th>`;
      }
      html += `</tr></thead><tbody>`;

      plan.forEach(week => {
        html += `
          <tr>
            <td>W${week.weekNum}</td>
            <td>${week.totalMileage}</td>
        `;
        // ข้อมูลรายวัน
        week.days.forEach(day => {
          html += `
            <td>
              ${day.distance} กม.
              <span class="workout-type">${day.workoutType}</span>
              <span class="pace-text">Pace: ${day.pace}</span>
            </td>
          `;
        });
        // กรณีบางวันไม่มี (ใน logic ที่อาจไม่ครอบคลุม)
        if (week.days.length < runDays) {
          for (let i = week.days.length; i < runDays; i++) {
            html += `<td>-</td>`;
          }
        }
        html += `</tr>`;
      });

      html += `</tbody></table>`;
      return html;
    }

    generatePlanBtn.addEventListener('click', () => {
      const distanceGoal = parseInt(document.getElementById('distanceGoal').value, 10); // 5,10,21,42
      const trainingWeeks = parseInt(document.getElementById('trainingWeeks').value, 10);
      const runDaysPerWeek = parseInt(document.getElementById('runDaysPerWeek').value, 10);
      const currentMileage = parseFloat(document.getElementById('currentMileage').value);

      // สร้างตาราง
      const plan = generateTrainingPlan(distanceGoal, trainingWeeks, runDaysPerWeek, currentMileage);
      // แสดงผล
      resultContainer.innerHTML = renderPlan(plan, runDaysPerWeek);
    });
  </script>
</body>
</html>
