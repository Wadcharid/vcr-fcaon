<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Combined TL Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Bootstrap 5 -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <style>
    thead tr {
      background-color: #007bff;
      color: #fff;
    }
    tfoot td {
      font-weight: bold;
      background: #f8f9fa;
    }
    input[type="number"] {
      min-width: 70px;
      text-align: right;
    }
    .distance-cell {
      min-width: 60px;
    }
  </style>
</head>

<body>
<div class="container my-4" style="max-width:900px;">
  <h2 class="mb-3 text-center">Combined TL Calculator</h2>

  <!-- โซนรับค่า LT Pace และ LTHR -->
  <div class="row mb-3">
    <div class="col-md-4 mb-2">
      <label class="form-label fw-bold">LT Pace (min:sec)</label>
      <div class="input-group">
        <input type="number" class="form-control" id="ltPaceMin" placeholder="Min" min="0"/>
        <span class="input-group-text">:</span>
        <input type="number" class="form-control" id="ltPaceSec" placeholder="Sec" min="0"/>
      </div>
    </div>
    <div class="col-md-4 mb-2">
      <label for="lthrInput" class="form-label fw-bold">LTHR (bpm)</label>
      <input type="number" class="form-control" id="lthrInput" placeholder="Enter LTHR" min="0"/>
    </div>
  </div>

  <!-- ตารางหลัก -->
  <div class="table-responsive mb-3">
    <table class="table table-bordered align-middle text-center" id="mainTable">
      <thead>
        <tr>
          <th>Pace (min)</th>
          <th>Pace (sec)</th>
          <th>HR (bpm)</th>
          <th>Duration (min)</th>
          <th>Distance (km)</th>
          <th>TL</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- แถวตัวอย่างเริ่มต้น 1 แถว -->
        <tr>
          <td><input class="paceMin form-control" type="number" min="0" /></td>
          <td><input class="paceSec form-control" type="number" min="0" /></td>
          <td><input class="hr form-control"      type="number" min="0" /></td>
          <td><input class="duration form-control" type="number" min="0" /></td>
          <td class="distance-cell"><span class="distance">0</span></td>
          <td><input class="tl form-control" type="number" min="0" /></td>
          <td><button class="btn btn-danger removeBtn">Remove</button></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="text-end fw-bold">รวม</td>
          <td id="footDuration" class="text-primary">0</td>
          <td id="footDistance" class="text-primary">0</td>
          <td id="footTL"       class="text-primary">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- ปุ่มเพิ่มแถว -->
  <div class="text-end">
    <button class="btn btn-primary" id="addRowBtn">Add Row</button>
  </div>
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ----- คำอธิบายสมการ -----
   1) TL1 = 0.0117 * exp(0.0581 * (HR * 100 / LTHR)) * Duration
   2) TL2 = 0.0699 * exp(0.0407 * X) * Duration
      โดย X = (LT_Pace_in_sec * 100) / paceInSec
   3) TL  = 0.5 * (TL1 + TL2)
   4) Distance = Duration / (paceInMin)  [paceInMin = paceInSec/60]
------------------------------------ */

//========== ฟังก์ชันคำนวณ TL จาก (paceInSec, hr, duration, ltPaceInSec, lthr) ==========//
function computeTL(paceInSec, hr, duration, ltPaceInSec, lthr) {
  // TL1
  const TL1 = 0.0127 * Math.exp(0.0581 * (hr * 100 / lthr)) * duration;
  // TL2
  if(paceInSec <= 0 || ltPaceInSec <= 0) return 0; // กัน NaN
  const X = (ltPaceInSec * 100) / paceInSec;
  const TL2 = 0.0709 * Math.exp(0.0407 * X) * duration;
  // TL
  return 0.5 * (TL1 + TL2);
}

//========== ฟังก์ชันคำนวณ Distance (จาก paceInSec, duration) ==========//
function computeDistance(paceInSec, duration) {
  if(paceInSec <= 0 || duration <= 0) return 0;
  const paceMin = paceInSec / 60; // pace (นาที/กม.)
  return duration / paceMin;      // (min) / (min/km) => km
}

//========== ฟังก์ชันแก้สมการ หา "paceInSec" ด้วย Binary Search ==========//
//   เมื่อรู้ hr, duration, TL, ltPaceInSec, lthr
//   โดย TL = computeTL(paceInSec, hr, duration, ltPaceInSec, lthr)
function solvePace(hr, duration, TL, ltPaceInSec, lthr) {
  // กำหนดขอบเขต paceInSec ที่เป็นไปได้ (เช่น 120 - 1200 วินาที/กม.)
  let left  = 60;    // 1:00 min/km (เร็วมากๆ)
  let right = 1800;  // 30:00 min/km (ช้ามากๆ)
  let eps   = 0.0001;
  let target = TL;

  for(let i=0; i<30; i++){  // วนจำกัดรอบ เช่น 30 ครั้ง
    let mid = (left + right)/2;
    let guessTL = computeTL(mid, hr, duration, ltPaceInSec, lthr);
    if(Math.abs(guessTL - target) < 0.0001) {
      return mid;
    }
    if(guessTL > target) {
      // ถ้า TL มากไป แปลว่า paceInSec น้อยไป (เร็วไป) => ต้องขยาย pace ให้มากขึ้น
      left = mid;
    } else {
      // ถ้า TL น้อยไป => paceInSec มากไป (ช้าไป) => ลด paceInSec
      right = mid;
    }
  }
  return (left + right)/2;  // ถ้าหาไม่ตรงมาก ก็คืนค่ากลาง
}

//========== ฟังก์ชันแก้สมการ หา "hr" ด้วย Binary Search ==========//
//   เมื่อรู้ paceInSec, duration, TL, ltPaceInSec, lthr
function solveHR(paceInSec, duration, TL, ltPaceInSec, lthr) {
  let left = 50;   // HR ต่ำๆ
  let right = 250; // HR สูงๆ
  for(let i=0; i<30; i++){
    let mid = (left + right)/2;
    let guessTL = computeTL(paceInSec, mid, duration, ltPaceInSec, lthr);
    if(Math.abs(guessTL - TL) < 0.0001) {
      return mid;
    }
    if(guessTL > TL) {
      right = mid;
    } else {
      left = mid;
    }
  }
  return (left + right)/2;
}

//========== ฟังก์ชันแก้สมการ หา "duration" ด้วย Binary Search ==========//
//   เมื่อรู้ paceInSec, hr, TL, ltPaceInSec, lthr
function solveDuration(paceInSec, hr, TL, ltPaceInSec, lthr) {
  let left = 1;    // 1 นาที
  let right = 600; // 10 ชม. = 600 นาที
  for(let i=0; i<30; i++){
    let mid = (left + right)/2;
    let guessTL = computeTL(paceInSec, hr, mid, ltPaceInSec, lthr);
    if(Math.abs(guessTL - TL) < 0.0001) {
      return mid;
    }
    if(guessTL > TL) {
      right = mid;
    } else {
      left = mid;
    }
  }
  return (left + right)/2;
}


//========== ฟังก์ชันหลัก: คำนวณ/แก้สมการของแต่ละแถว เมื่อมีการเปลี่ยน input ==========//
function recalcRow(tr, changedClass) {
  const ltPaceMin = parseInt(document.getElementById("ltPaceMin").value) || 0;
  const ltPaceSec = parseInt(document.getElementById("ltPaceSec").value) || 0;
  const lthr      = parseFloat(document.getElementById("lthrInput").value) || 0;
  const ltPaceInSec = ltPaceMin*60 + ltPaceSec;  // หน่วยวินาที/กม. (ของ LT Pace)

  const paceMinInput  = tr.querySelector(".paceMin");
  const paceSecInput  = tr.querySelector(".paceSec");
  const hrInput       = tr.querySelector(".hr");
  const durationInput = tr.querySelector(".duration");
  const tlInput       = tr.querySelector(".tl");
  const distSpan      = tr.querySelector(".distance");

  let paceMin   = parseInt(paceMinInput.value) || 0;
  let paceSec   = parseInt(paceSecInput.value) || 0;
  let hr        = parseFloat(hrInput.value)    || 0;
  let duration  = parseFloat(durationInput.value) || 0;
  let tl        = parseFloat(tlInput.value)       || 0;

  if(lthr <= 0 || ltPaceInSec <= 0) {
    // ถ้า LTHR หรือ LT Pace ยังไม่ถูก set ก็ให้ clear TL=0 หรือเตือน
    // (แล้วแต่จะออกแบบ ตรงนี้ขอแค่กัน error)
    // console.warn("กรุณาระบุ LTHR และ LT Pace ให้ครบก่อน");
    updateDistanceAndFooter(tr, 0, 0);
    return;
  }

  // paceInSec
  let paceInSec = paceMin*60 + paceSec;

  // นับจำนวนฟิลด์ (paceInSec>0 ?, hr>0 ?, duration>0 ?, tl>0 ?)
  let hasPace    = (paceInSec > 0);
  let hasHR      = (hr > 0);
  let hasDur     = (duration > 0);
  let hasTL      = (tl > 0);

  let countKnown = [hasPace, hasHR, hasDur, hasTL].filter(x=>x).length;
  
  // 1) ถ้า countKnown < 3 => ยังไม่คำนวณอะไร (ต้องการให้กรอกให้ได้ 3 ตัวก่อน)
  if(countKnown < 3) {
    // อัปเดต Distance ตาม Pace+Duration ถ้ามี
    let dist = computeDistance(paceInSec, duration);
    distSpan.textContent = dist.toFixed(2);
    updateFooterTotals();
    return;
  }

  // 2) ถ้า countKnown == 4 => เราคำนวณค่า TL ใหม่ (หรือปรับทีเดียว)
  //    แต่ในที่นี้จะถือเอาว่าถ้าผู้ใช้กรอกครบ 4 อาจจะ override TL ด้วยค่าที่คำนวณ
  //    (หรือจะไม่ทำอะไร ก็แล้วแต่การออกแบบ)
  //    ตรงนี้จะทำเหมือนในกรณี "คำนวณ TL" เพื่อ sync ให้ถูกต้อง
  if(countKnown == 4 && (changedClass==="paceMin" || changedClass==="paceSec" || changedClass==="hr" || changedClass==="duration")) {
    // สมมติ override TL
    let computed = computeTL(paceInSec, hr, duration, ltPaceInSec, lthr);
    tlInput.value = computed.toFixed(1);
    tl = computed;
  }

  // 3) ถ้า countKnown == 3 หรือ 4 => เช็คว่า "ตัวไหน" เป็นตัวที่ยังไม่ได้ใส่ (หรือเป็นตัวที่ต้องคำนวณ)
  if(!hasPace) {
    // Solve for Pace
    // ใช้ TL, HR, Duration, LTHR, LT Pace => หา paceInSec
    let paceSecFound = solvePace(hr, duration, tl, ltPaceInSec, lthr);
    paceInSec = paceSecFound;
    // อัปเดตลงช่อง Pace (min,sec)
    let pm = Math.floor(paceInSec/60);
    let ps = Math.round(paceInSec - pm*60);
    paceMinInput.value = pm;
    paceSecInput.value = ps;
  }
  else if(!hasHR) {
    // Solve for HR
    let hrFound = solveHR(paceInSec, duration, tl, ltPaceInSec, lthr);
    hrInput.value = hrFound.toFixed(1);
    hr = hrFound;
  }
  else if(!hasDur) {
    // Solve for Duration
    let durFound = solveDuration(paceInSec, hr, tl, ltPaceInSec, lthr);
    durationInput.value = durFound.toFixed(1);
    duration = durFound;
  }
  else if(!hasTL) {
    // Compute TL
    let computed = computeTL(paceInSec, hr, duration, ltPaceInSec, lthr);
    tlInput.value = computed.toFixed(1);
    tl = computed;
  }
  else {
    // กรณี countKnown==4 แล้ว ผู้ใช้เพิ่งปรับ TL => หา duration ใหม่ (ตามเงื่อนไขข้อ 4)
    if(changedClass==="tl") {
      let durFound = solveDuration(paceInSec, hr, tl, ltPaceInSec, lthr);
      durationInput.value = durFound.toFixed(1);
      duration = durFound;
    }
    else {
      // ถ้าปรับ pace/hr/duration => compute TL
      let computed = computeTL(paceInSec, hr, duration, ltPaceInSec, lthr);
      tlInput.value = computed.toFixed(1);
      tl = computed;
    }
  }

  // 4) สุดท้ายคำนวณ Distance
  let dist = computeDistance(paceInSec, duration);
  distSpan.textContent = dist.toFixed(2);

  // 5) อัปเดต Footer
  updateFooterTotals();
}

// อัปเดตผลรวมใน tfoot
function updateFooterTotals() {
  const rows = document.querySelectorAll("#mainTable tbody tr");
  let sumDur = 0, sumTL = 0, sumDist = 0;
  rows.forEach((tr)=>{
    const durVal = parseFloat(tr.querySelector(".duration")?.value) || 0;
    const tlVal  = parseFloat(tr.querySelector(".tl")?.value)       || 0;
    const distVal= parseFloat(tr.querySelector(".distance")?.textContent) || 0;
    sumDur  += durVal;
    sumTL   += tlVal;
    sumDist += distVal;
  });
  document.getElementById("footDuration").textContent = sumDur.toFixed(1);
  document.getElementById("footDistance").textContent = sumDist.toFixed(2);
  document.getElementById("footTL").textContent       = sumTL.toFixed(1);
}

// ผูก event ให้แถว
function attachEvents(tr) {
  const inputs = tr.querySelectorAll("input");
  inputs.forEach((inp)=>{
    inp.addEventListener("change", (e)=>{
      if(e.target.classList.contains("paceMin"))  recalcRow(tr,"paceMin");
      else if(e.target.classList.contains("paceSec")) recalcRow(tr,"paceSec");
      else if(e.target.classList.contains("hr"))       recalcRow(tr,"hr");
      else if(e.target.classList.contains("duration")) recalcRow(tr,"duration");
      else if(e.target.classList.contains("tl"))       recalcRow(tr,"tl");
    });
  });

  // ปุ่ม remove
  const removeBtn = tr.querySelector(".removeBtn");
  removeBtn.addEventListener("click", ()=>{
    tr.parentNode.removeChild(tr);
    updateFooterTotals();
  });
}

// เพิ่มแถว
function addRow() {
  const tbody = document.querySelector("#mainTable tbody");
  const newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td><input class="paceMin form-control" type="number" min="0" /></td>
    <td><input class="paceSec form-control" type="number" min="0" /></td>
    <td><input class="hr form-control"      type="number" min="0" /></td>
    <td><input class="duration form-control" type="number" min="0" /></td>
    <td class="distance-cell"><span class="distance">0</span></td>
    <td><input class="tl form-control" type="number" min="0" /></td>
    <td><button class="btn btn-danger removeBtn">Remove</button></td>
  `;
  tbody.appendChild(newRow);
  attachEvents(newRow);
}

document.addEventListener("DOMContentLoaded", ()=>{
  // แนบ event ให้กับแถวแรก
  const firstRow = document.querySelector("#mainTable tbody tr");
  attachEvents(firstRow);

  // ปุ่ม Add Row
  document.getElementById("addRowBtn").addEventListener("click", addRow);

  // ถ้าเปลี่ยน LT Pace หรือ LTHR => รีคำนวณทุกแถว
  const ltPaceMinInput = document.getElementById("ltPaceMin");
  const ltPaceSecInput = document.getElementById("ltPaceSec");
  const lthrInput      = document.getElementById("lthrInput");

  [ltPaceMinInput, ltPaceSecInput, lthrInput].forEach(ip=>{
    ip.addEventListener("change", ()=>{
      const rows = document.querySelectorAll("#mainTable tbody tr");
      rows.forEach((r)=> recalcRow(r, "paceMin")); // สมมติให้เรียกเหมือนเปลี่ยน pace เพื่อให้มันคำนวณใหม่
    });
  });
});
</script>
</body>
</html>
